version: '3.1'

services:
  grafana:
    image: grafana/grafana-enterprise
    container_name: grafana
    restart: unless-stopped
    # if you are running as root then set it to 0
    # else find the right id with the id -u command
    user: '0'
    networks:
      - sqldb
    environment:
      - GF_DEFAULT_LANGUAGE=fr
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      - GF_AUTH_ANONYMOUS_ORG_NAME=Main Org.
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_PANELS_DISABLE_SANITIZE_HTML=true
      - GF_SECURITY_ADMIN_USER=${DBUSER:-opps}
      - GF_SECURITY_ADMIN_PASSWORD=${DBPWD:-imnotthepwd}
    ports:
      - '8080:3000'
    # adding the mount volume point which we create earlier
    volumes:
      - '$PWD/data:/var/lib/grafana'
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./grafana/fr.json:/usr/share/grafana/public/locales/fr.json
  pg:
    image: postgres:alpine
    container_name: ${DBHOST:-sqldb-ws-pg}
    hostname: ${DBHOST:-sqldb-ws-pg}
    restart: always
    volumes:
      - ./db/autoload:/docker-entrypoint-initdb.d
      - pg_data:/var/lib/postgresql/data
      - "./certs:/certs"
    networks:
      - sqldb
    environment:
      POSTGRES_DB: ${DBNAME:-opps}
      POSTGRES_USER: ${DBUSER:-opps}
      POSTGRES_PASSWORD: ${DBPWD:-imnotthepwd}
    ports: 
      - 5432:5432

  adminer:
    image: adminer
    restart: always
    networks:
      - sqldb
    ports:
      - 8443:8080
    environment:
      ADMINER_DEFAULT_DRIVER: pgsql
      ADMINER_DEFAULT_SERVER: sqldb-ws-pg
  sqldb-ws:
    image: irtse/sqldb-ws:latest
    restart: always
    build:
      context: .
      dockerfile: Dockerfile
    networks:
      - sqldb
    ports: 
      - 8081:8080
    volumes:
      - ./files:/mnt/files
      - ./html:/opt/html
      - ${PLUGIN_FILES:-/dev/null}:/mnt/plugin_files
    labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sqldb.entrypoints=websecure"
        - "traefik.http.routers.sqldb.rule=Host(`${HOST_SHORT:-opps.irt-aese.local}`) && PathPrefix(`/v1`)"
        - "traefik.http.services.sqldb.loadbalancer.server.port=8080"
        - "traefik.http.routers.sqldb.tls=true"
    environment:
      LDAP_ADDR: ${LDAP_ADDR:-ldap://irt00v001.irt-aese.local:389}
      LDAP_USR: ${LDAP_USR:-CN=read only,OU=Utilisateurs,OU=YZ - Technique,OU=AD - IRT-AESE,DC=IRT-AESE,DC=local}
      LDAP_OU: ${LDAP_USR:-OU=AD - IRT-AESE,DC=IRT-AESE,DC=local}
      LDAP_PWD: ${LDAP_PWD:-IRT@2015}
      SMTP_HOST: ${SMTP_HOST:-mail.irt-saintexupery.com}
      SMTP_PORT: ${SMTP_PORT:-25}
      SUPERADMIN_NAME: ${SUPERADMIN_NAME:-root}
      SUPERADMIN_EMAIL: ${SUPERADMIN_EMAIL:-pro.morgane.roques@gmail.com}
      SUPERADMIN_PASSWORD: ${SUPERADMIN_PASSWORD:-imnotthepwd}
      AUTH_MODE: ${AUTH_MODE:-ldap}
      DBDRIVER : ${DBDRIVER:-postgres}
      DBHOST : ${DBHOST:-sqldb-ws-pg}
      DBPORT : ${DBPORT:-5432}
      DBUSER : ${DBUSER:-opps}
      DBPWD : ${DBPWD:-imnotthepwd}
      DBNAME: ${DBNAME:-opps}
      DBSSL: ${DBSSL:-enable}
      HOST: ${HOST:-https://opps.irt-saintexupery.com}
      USER_FILE_PATH: ${USER_FILE_PATH:-Salarié.csv}
      PROJECT_FILE_PATH: ${PROJECT_FILE_PATH:-Projets.csv}
      VISIBILITY_FILE_PATH: ${VISIBILITY_FILE_PATH:-Visibilité_projet.csv}
networks:
  sqldb:
    external: true
volumes:
  pg_data: